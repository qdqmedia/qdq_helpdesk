{% load i18n %}
{% load stringdate %}

{% if ticket.followup_set.all %}
    <h3 id="followup-h3"><a href="#">{% trans "Follow-Ups" %}</a></h3>

    <div id="followup-data">
    {% load ticket_to_link %}

    {% for followup in followups %}
        <ul>
        {% if helpdesk_settings.HELPDESK_FOLLOWUP_MOD %}
            <div class='title'>
                <span class='byline'>{{ followup.user.get_full_name }}&nbsp;&nbsp;&nbsp;&nbsp;{{ followup.date }} ({{ followup.date|timesince }} ago)</span> <small>{{ followup.title }}</small>
                {% if not followup.public %} <span class='private'>({% trans "Private" %})</span>{% endif %}
                {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                    {% if followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                    <a href="{% url helpdesk_followup_edit ticket.id followup.id %}" class='followup-edit'><img width="60" height="15" title="Edit" alt="Edit" src="{{ STATIC_URL }}helpdesk/buttons/edit.png"></a>
                    {% endif %}
                {% endif %}
                {% if user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                    <a href="{% url helpdesk_followup_delete ticket.id followup.id %}" class='followup-edit'><img width="60" height="15" title="Delete" alt="Delete" src="{{ STATIC_URL }}helpdesk/buttons/delete.png"></a>
                {% endif %}
            </div>

        {% else %}

            <li>
                {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                    {% if followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                    <a class="btn btn-small" href="{% url helpdesk_followup_edit ticket.id followup.id %}" title="Editar"><i class="icon-pencil"></i></a>
                    {% endif %}
                {% endif %}
                {% if user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                    <a class="btn btn-small" href="{% url helpdesk_followup_delete ticket.id followup.id %}" title="Borrar"><i class="icon-remove"></i></a>
                {% endif %}

                <b>{{ followup.title }} </b><span class='byline'>{% if followup.user %}por <em>{{ followup.user }}</em>{% endif %} <span title='{{ followup.date|date:"r" }}'> hace {{ followup.date|timesince }}</span>{% if not followup.public %} <span class='private'>({% trans "Private" %})</span>{% endif %}</span>
           </li>

        {% endif %}

        <span class='followup-desc'>{% if followup.comment %}{{ followup.comment|safe|urlizetrunc:50|num_to_link|linebreaksbr }}{% endif %}</span>

        {% for change in followup.ticketchange_set.all %}
            {% if forloop.first %}
                <div class='changes'>
                    <ul>
             {% endif %}
            <li>
              Cambiado <b>{% trans change.field %}</b>
              {% if change.old_value %}
                de <b>{% trans change.old_value %}</b>
              {% endif %}
              a <b>
              {% if change.field == "Due on" %}
                {{ change.new_value|string_to_date }}</b>
              {% else %}
                {% trans change.new_value %}</b>
              {% endif %}
            </li>
            {% if forloop.last %}</ul></div>{% endif %}
        {% endfor %}

        {% for attachment in followup.attachment_set.all %}
            {% if forloop.first %}<div class='attachments'><ul>{% endif %}
            <li><a href='{{ attachment.file.url }}'>{{ attachment.filename }}</a> ({{ attachment.mime_type }}, {{ attachment.size|filesizeformat }})
            {% if followup.user and request.user == followup.user %}
                <a href='{% url helpdesk_attachment_del ticket.id attachment.id %}'>delete</a>
            {% endif %}
            </li>
            {% if forloop.last %}</ul></div>{% endif %}
        {% endfor %}

        </ul> <!-- class: followup -->

    {% endfor %}

{% endif %}
</div>
