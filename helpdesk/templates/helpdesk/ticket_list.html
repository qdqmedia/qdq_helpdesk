{% extends "helpdesk/base.html" %}
{% load i18n %}
{% block helpdesk_title %}{% trans "Ticket Listing" %}{% endblock %}
{% block helpdesk_head %}
<script src="{{ STATIC_URL }}helpdesk/filter.js"></script>
<script src="{{ STATIC_URL }}helpdesk/hover.js"></script>

<script type="text/javascript">
$(document).ready(function() {
    // Enable Tabs
    $("#searchtabs").tabs({
        collapsible:true
    });
    // Hide all tabs by default
    $("#searchtabs > ul > li").removeClass().addClass("ui-corner-top ui-state-default");
    $("#searchtabs > div").addClass("ui-tabs-hide");

    $("#select_all").click(function() {
        $(".ticket_multi_select").attr("checked", true);
        return false;
    });
    $("#select_none").click(function() {
        $(".ticket_multi_select").attr("checked", false);
        return false;
    });
    $("#select_inverse").click(function() {
        $(".ticket_multi_select").each(function() {
            $(this).attr("checked", !$(this).attr("checked"));
        });
        return false;
    });

    $('#filterBoxOwner').hide();
    $('#filterBoxQueue').hide();
    $('#filterBoxStatus').hide();
    $('#filterBoxDates').hide();
    $('#filterBoxKeywords').hide();
});
</script>
{% endblock %}
{% block helpdesk_body %}

{% load in_list %}

<div id="searchtabs">
    <ul>
        <li><a href='#tabfilter'>{% trans "Query Options" %}</a></li>
        {% if not from_saved_query %}
            <li><a href='#tabsave'>{% trans "Save This Query" %}</a></li>
        {% endif %}
        {% if user_saved_queries %}
            <li><a href='#tabload'>{% trans "Load Saved Query" %}</a></li>
        {% endif %}
    </ul>
    <div id='tabfilter'>
    <h3>{% trans "Change Query" %}</h3>
    <form class="form-horizontal">
        <div class="control-group">
            <label class="control-label">{% trans 'Add filter' %}</label>
            <div class="controls">
                <select name='select' id='filterBuilderSelect'>
                    <option value='Sort'>{% trans "Sorting by" %}</option>
                    <option value='Owner'>{% trans "Owner" %}</option>
                    <option value='Queue'>{% trans "Queue" %}</option>
                    <option value='Status'>{% trans "Status" %}</option>
                    <option value='Keywords'>{% trans "Keywords" %}</option>
                    <option value='Dates'>{% trans "Date Range" %}</option>
                {% if tags_enabled %}
                    <option value='Tags'>{% trans "Tags" %}</option>
                {% endif %}
                </select>
                <input type='button' id='filterBuilderButton' value='+' />
            </div>
           </div>
    {% csrf_token %}
   </form>

  <form method='get' action='./' class="form-horizontal">
    <div class='filterBox{% if query_params.sorting %} filterBoxShow{% endif %}' id='filterBoxSort'>
            <div class="control-group">
                <button class="close btn-close filterBuilderRemove">&times;</button>
                <label for='id_sort' class="control-label">{% trans "Sorting by" %}</label>
                <div class="controls">
                    <select id='id_sort' name='sort'>
                        <option value='created'{% ifequal query_params.sorting "created"%} selected='selected'{% endifequal %}>
                            {% trans "Created" %}
                        </option>
                        <option value='title'{% ifequal query_params.sorting "title"%} selected='selected'{% endifequal %}>
                            {% trans "Title" %}
                        </option>
                        <option value='queue'{% ifequal query_params.sorting "queue"%} selected='selected'{% endifequal %}>
                            {% trans "Queue" %}
                        </option>
                        <option value='status'{% ifequal query_params.sorting "status"%} selected='selected'{% endifequal %}>
                            {% trans "Status" %}
                        </option>
                        <option value='priority'{% ifequal query_params.sorting "priority"%} selected='selected'{% endifequal %}>
                            {% trans "Priority" %}
                        </option>
                        <option value='assigned_to'{% ifequal query_params.sorting "assigned_to"%} selected='selected'{% endifequal %}>
                            {% trans "Owner" %}
                        </option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label for='id_sortreverse' class="control-label">{% trans "Reverse" %}</label>
                <div class="controls">
                    <input type='checkbox' name='sortreverse' id='id_sortreverse'{% if query_params.sortreverse %} checked='checked'{% endif %} />
                    <p class='filterHelp'>{% trans "Ordering applied to tickets" %}</p>
                </div>
            </div>
    </div>

    <div class='filterBox{% if query_params.filtering.assigned_to__id__in %} filterBoxShow{% endif %}' id='filterBoxOwner'>
        <div class="control-group">
            <button class="close btn-close filterBuilderRemove">&times;</button>
            <label for='id_owners' class="control-label">{% trans "Owner(s)" %}</label>
            <div class="controls">
                <select id='id_owners' name='assigned_to' multiple='selected' size='5'>
                    {% for u in user_choices %}
                    <option value='{{ u.id }}'{% if u.id|in_list:query_params.filtering.assigned_to__id__in %} selected='selected'{% endif %}>
                        {{ u.username }}{% ifequal u user %} {% trans "(ME)" %}{% endifequal %}
                    </option>
                    {% endfor %}
                </select>
                <p class='filterHelp'>{% trans "Ctrl-Click to select multiple options" %}</p>
            </div>
        </div>
    </div>

    <div class='filterBox{% if query_params.filtering.queue__id__in %} filterBoxShow{% endif %}' id='filterBoxQueue'>
        <div class="control-group">
            <button class="close btn-close filterBuilderRemove">&times;</button>
            <label for='id_queues' class="control-label">{% trans "Queue(s)" %}</label>
            <div class="controls">
                <select id='id_queues' name='queue' multiple='selected' size='5'>{% for q in queue_choices %}<option value='{{ q.id }}'{% if q.id|in_list:query_params.filtering.queue__id__in %} selected='selected'{% endif %}>{{ q.title }}</option>{% endfor %}</select>
                <p class='filterHelp'>{% trans "Ctrl-click to select multiple options" %}</p>
            </div>
         </div>
    </div>

    <div class='filterBox{% if query_params.filtering.status__in %} filterBoxShow{% endif %}' id='filterBoxStatus'>
        <div class="control-group">
            <button class="close btn-close filterBuilderRemove">&times;</button>
            <label for='id_statuses' class="control-label">{% trans "Status(es)" %}</label>
            <div class="controls">
                <select id='id_statuses' name='status' multiple='selected' size='5'>{% for s in status_choices %}<option value='{{ s.0 }}'{% if s.0|in_list:query_params.filtering.status__in %} selected='selected'{% endif %}>{{ s.1 }}</option>{% endfor %}</select>
                <p class='filterHelp'>{% trans "Ctrl-click to select multiple options" %}</p>
            </div>
        </div>
    </div>

    <div class='filterBox{% if query_params.filtering.created__gte or query_params.filtering.created__lte %} filterBoxShow{% endif %}' id='filterBoxDates'>
        <div class="control-group">
            <button class="close btn-close filterBuilderRemove">&times;</button>
            <label for='id_date_from' class="control-label">{% trans "Date (From)" %}</label>
            <div class="controls">
                <input type='text' name='date_from' value='{{ query_params.filtering.created__gte }}' id='id_date_from' />
             </div>
        </div>
        <div class="control-group">
            <label for='id_date_to' class="control-label">{% trans "Date (To)" %}</label>
            <div class="controls">
                <input type='text' name='date_to' value='{{ query_params.filtering.created__lte }}' id='id_date_to' />
                <p class='filterHelp' class="control-label">{% trans "Use YYYY-MM-DD date format, eg 2011-05-29" %}</p>
            </div>
         </div>
    </div>

    {% if tags_enabled %}
        <div class='filterBox{% if query_params.tags %} filterBoxShow{% endif %}' id='filterBoxTags'>
            <div class="control-group">
              <button class="close btn-close filterBuilderRemove">&times;</button>
              <label for='id_tags' class="control-label">{% trans "Tag(s)" %}</label>
              <div class="controls">
                <select id='id_tags' name='tags' multiple='selected' size='5'>{% for t in tag_choices %}<option value='{{t.name}}'{% if t.name|in_list:query_params.tags %} selected='selected'{% endif %}>{{ t.name }}</option>{% endfor %}</select>
                <p class='filterHelp'>{% trans "Ctrl-click to select multiple options" %}</p>
              </div>
            </div>
        </div>
    {% endif %}

    <div class='filterBox{% if query %} filterBoxShow{% endif %}' id='filterBoxKeywords'>
        <div class="control-group">
            <button class="close btn-close filterBuilderRemove">&times;</button>
            <label for='id_query' class="control-label">{% trans "Keywords" %}</label>
            <div class="controls">
                <input type='text' name='q' value='{{ query }}' id='id_query' />
                <p class='filterHelp'>{% trans "Keywords are case-insensitive, and will be looked for in the title, body and submitter fields." %}</p>
             </div>
         </div>
    </div>

 </form>


  <form method='get' action='./'>
    <hr style='clear: both;' />
    <button type="submit" class="btn btn-success btn-small">{% trans "Apply Filter" %}</button>
    {% if from_saved_query and saved_query.user = user %}
        <p>{% blocktrans with saved_query.title as query_name %}You are currently viewing saved query <em>{{ query_name }}</em>.{% endblocktrans %} <a href='{% url helpdesk_delete_query saved_query.id %}'>{% trans "Delete Saved Query" %}</a></p>
    {% endif %}

    {% if from_saved_query %}
        <p>{% blocktrans with saved_query.id as query_id %}<a href='../reports/?saved_query={{ query_id }}'>Run a report</a> on this query to see stats and charts for the data listed below.{% endblocktrans %}</p>
    {% endif %}
    {% csrf_token %}
   </form>
</div>


    {% if not from_saved_query %}
        <div class='tab' id='tabsave'>
            <h3>{% trans "Save Query" %}</h3>
            <form method="post" action="{% url helpdesk_savequery %}" class="form-horizontal">
                <div class="control-group">
                    <label for='id_title' class="control-label">{% trans "Query Name" %}</label>
                    <div class="controls">
                        <input type='hidden' name='query_encoded' value='{{ urlsafe_query }}' />
                        <input type='text' name='title' id='id_title' />
                        <p class='form_help_text'>{% trans "This name appears in the drop-down list of saved queries. If you share your query, other users will see this name, so choose something clear and descriptive!" %}</p>
                     </div>
                </div>
                <div class="control-group">
                    <label for='id_shared' class="control-label">{% trans "Shared?" %}</label>
                    <div class="controls">
                        <input type='checkbox' name='shared' id='id_shared' /> {% trans "Yes, share this query with other users." %}
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <button type="submit" class="btn btn-success">{% trans "Save Query" %}</button>
                    </div>
                </div>
                {% csrf_token %}
            </form>
        </div>
    {% endif %}

    <div id='tabload'>
        <h3>{% trans "Use Saved Query" %}</h3>
        <form method='get' action='{% url helpdesk_list %}' class="form-horizontal">
            <div class="control-group">
                <label for='id_query_selector' class="control-label">{% trans "Query" %}</label>
                <div class="controls">
                    <select name='saved_query' id='id_query_selector'>
                    {% for q in user_saved_queries %}
                        <option value='{{ q.id }}'>{{ q.title }}{% if q.shared %} ({% trans 'Shared' %}{% ifnotequal user q.user %} by {{ q.user.username }}{% endifnotequal %}){% endif %}</option>
                    {% endfor %}
                    </select>
                </div>
             </div>
             <div class="control-group">
                 <div class="controls">
                    <button type="submit" class="btn btn-success">{% trans "Run Query" %}</button>
                  </div>
             </div>
            {% csrf_token %}
        </form>
    </div>
</div>

<br/>
{{ search_message|safe }}
<form method='post' action='{% url helpdesk_mass_update %}' id="ticket_mass_update" class="form-inline">
<table class="table table-hover">
    <caption>{% trans 'Tickets listing' %}</caption>
    <tr>
        <th>&nbsp;</th>
        <th>{% trans "[Queue-Num]" %}</th>
        <th>{% trans "Pr" %}</th>
        <th>{% trans "Title" %}</th>
        <th>{% trans "Queue" %}</th>
        <th>{% trans "Status" %}</th>
        <th>{% trans "Created" %}</th>
        <th>{% trans "Assigned to" %}</th>
        {% if tags_enabled %}<th>{% trans "Tags" %}</th>{% endif %}
    </tr>
    {% for ticket in tickets.object_list %}
        <tr>
            <td>
              <input type='checkbox' name='ticket_id' value='{{ ticket.id }}' class='ticket_multi_select' />
           </td>
           <td>
               <a href="{{ ticket.get_absolute_url }}">{{ ticket.ticket }}</a>
           </td>
           <td>{{ ticket.get_priority_span }}</td>
           <td><a href="{{ ticket.get_absolute_url }}">{{ ticket.title }}</a></td>
           <td>{{ ticket.queue }}</td>
           <td>{{ ticket.get_status }}</td>
           <td>
               <span title='{{ ticket.created|date:"r" }}'>hace {{ ticket.created|timesince }}</span>
               </td>
           <td>{{ ticket.get_assigned_to }}</td>
           {% if tags_enabled %}
              <td>{{ ticket.tags }}</td>
           {% endif %}
        </tr>
    {% empty %}
        <tr>
            <td colspan='5'>{% trans "No Tickets Match Your Selection" %}</td>
        </tr>
    {% endfor %}
</table>

<span>P&aacute;gina {{ tickets.number }} de {{ tickets.paginator.num_pages }}</span>
<div class="pager">
        <ul>
        {% if tickets.has_previous %}
            <li>
                <a href="?{% if query_string %}{{ query_string }}&amp;{% endif %}page={{ tickets.previous_page_number }}">&lt;&lt; {% trans "Previous" %}</a>
             </li>
        {% endif %}
        {% if tickets.has_next %}
            <li>
                <a href="?{% if query_string %}{{ query_string }}&amp;{% endif %}page={{ tickets.next_page_number }}">{% trans "Next" %} &gt;&gt;</a>
            </li`>
       {% endif %}
       </ul>
</div>

    <p>
        <a href='#select_all' id='select_all' class="btn btn-warning">{% trans "Select All" %}</a>
        <a href='#select_none' id='select_none' class="btn btn-warning">{% trans "Select None" %}</a>
        <a href='#select_inverse' id='select_inverse' class="btn btn-warning">{% trans "Select Inverse" %}</a>
    </p>

    <label for='id_mass_action'>{% trans "Actions with selected tickets:" %}</label>
        <select name='action' id='id_mass_action'>
            <option value='take'>{% trans "Take (Assign to me)" %}</option>
            <option value='delete'>{% trans "Delete" %}</option>
            <optgroup label='{% trans "Close" %}'>
                <option value='close'>{% trans "Close (Don't Send E-Mail)" %}</option>
                <option value='close_public'>{% trans "Close (Send E-Mail)" %}</option>
            </optgroup>
            <optgroup label='{% trans "Assign To" %}'>
                <option value='unassign'>{% trans "Nobody (Unassign)" %}</option>
                {% for u in user_choices %}
                    <option value='assign_{{ u.id }}'>{{ u.username }}</option>
                {% endfor %}
            </optgroup>
        </select>
        <button type="submit" class="btn btn-success btn-small">{% trans "Run" %}</button>
{% csrf_token %}
</form>
{% endblock %}
